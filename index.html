        },
        plugins: {
          legend: { display: true }
        }
      }
    });

    function addLinePoint(value) {
      const now = new Date();
      const label = now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0');

      lineChart.data.labels.push(label);
      lineChart.data.datasets[0].data.push(value);

      // Jika terlalu panjang, batasi misalnya 50 titik terakhir
      if (lineChart.data.labels.length > 50) {
        lineChart.data.labels.shift();
        lineChart.data.datasets[0].data.shift();
      }

      lineChart.update();
    }

    /*********** MQTT CONNECTION ***********/
    const mqttStatusEl = document.getElementById('mqtt-status');

    const mqttOptions = {
      username: 'raynaldo',
      password: 'Raynaldo123',
      keepalive: 60,
      reconnectPeriod: 1000,
      connectTimeout: 30 * 1000
    };

    // URL WebSocket TLS HiveMQ Cloud
    const mqttUrl = 'wss://2f0213f3aad24f2ca0e61050c1d92849.s1.eu.hivemq.cloud:8884/mqtt';

    let client;

    try {
      client = mqtt.connect(mqttUrl, mqttOptions);
    } catch (err) {
      console.error('Error in mqtt.connect:', err);
    }

    if (client) {
      client.on('connect', () => {
        console.log('MQTT connected');
        mqttStatusEl.textContent = 'MQTT: Connected';
        client.subscribe('sensor/proximity', { qos: 0 }, (err) => {
          if (err) {
            console.error('Subscribe error:', err);
          } else {
            console.log('Subscribed to sensor/proximity');
          }
        });
      });

      client.on('reconnect', () => {
        console.log('MQTT reconnecting...');
        mqttStatusEl.textContent = 'MQTT: Reconnecting...';
      });

      client.on('error', (err) => {
        console.error('MQTT error:', err);
        mqttStatusEl.textContent = 'MQTT: Error';
      });

      client.on('close', () => {
        console.log('MQTT disconnected');
        mqttStatusEl.textContent = 'MQTT: Disconnected';
      });

      client.on('message', (topic, message) => {
        const raw = message.toString();
        console.log('MQTT topic:', topic, 'payload:', raw);

        let speed = NaN;

        // 1) Coba angka langsung, mis: "123.4"
        speed = parseFloat(raw);

        // 2) Kalau bukan angka, coba asumsikan JSON
        //    misalnya: {"speed":123.4} / {"kecepatan":"123.4"} / {"value": "123.4"}
        if (isNaN(speed)) {
          try {
            const obj = JSON.parse(raw);
            const kandidatKey = ['speed', 'kecepatan', 'mmin', 'value'];

            for (const k of kandidatKey) {
              if (obj.hasOwnProperty(k)) {
                if (typeof obj[k] === 'number') {
                  speed = obj[k];
                  break;
                }
                if (typeof obj[k] === 'string') {
                  const parsed = parseFloat(obj[k]);
                  if (!isNaN(parsed)) {
                    speed = parsed;
                    break;
                  }
                }
              }
            }
          } catch (e) {
            console.warn('Gagal parse JSON, payload:', raw);
          }
        }

        if (!isNaN(speed)) {
          console.log('Kecepatan terdeteksi:', speed, 'M/min');
          updateGauge(speed);
          addLinePoint(speed);
        } else {
          console.warn('Tidak menemukan angka kecepatan di payload:', raw);
        }
      });
    } else {
      mqttStatusEl.textContent = 'MQTT: init gagal';
    }

    // Set nilai awal gauge 0
    updateGauge(0);
  </script>
</body>
</html>
